# Copyright (c) Mondoo, Inc.
# SPDX-License-Identifier: BUSL-1.1

packs:
  - uid: mondoo-macos-incident-response
    name: macOS Incident Response Pack
    version: 1.1.0
    license: BUSL-1.1
    authors:
      - name: Mondoo, Inc
        email: hello@mondoo.com
    tags:
      mondoo.com/platform: macos
      mondoo.com/category: security
    docs:
      desc: |
        ### Overview

        The macOS Incident Response Pack by Mondoo retrieves configuration data from macOS hosts for investigation during a security incident. This includes platform information, user accounts, kernel details, running processes, mounted devices, installed packages, running services, firewall exceptions, and pending software updates.

        ### Run query pack

        To run this query pack locally on a macOS host:

        ```bash
        cnquery scan local -f mondoo-macos-incident-response.mql.yaml
        ```

        To run against a remote macOS host using SSH:

        ```bash
        cnquery scan ssh <user>@<ip_address> -f mondoo-macos-incident-response.mql.yaml
        ```
    filters:
      - asset.platform == "macos"
    queries:
      - uid: mondoo-macos-incident-response-platform-info
        title: Platform information
        docs:
          desc: Retrieves the macOS platform, version, and architecture to identify the affected system.
        mql: asset { platform title version arch }
      - uid: mondoo-macos-incident-response-regular-users
        title: Regular users
        docs:
          desc: Lists regular user accounts (excluding system accounts) to identify potentially compromised or unauthorized user accounts.
        mql: users.where( name != /^_/ && shell != /\/usr\/bin\/false/ )
      - uid: mondoo-macos-incident-response-kernel-info
        title: Running macOS kernel
        docs:
          desc: Returns the currently running kernel version to identify potential kernel-level vulnerabilities.
        mql: kernel.info.version
      - uid: mondoo-macos-incident-response-kernel-modules
        title: macOS kernel modules
        docs:
          desc: Lists all kernel extensions with their load status to identify potentially malicious or unauthorized kernel extensions.
        mql: kernel.modules { name loaded }
      - uid: mondoo-macos-incident-response-processes
        title: Running processes
        docs:
          desc: Lists all running processes with their PID and command to identify suspicious or malicious processes.
        mql: processes.list { pid  command }
      - uid: mondoo-macos-incident-response-mounts
        title: Mounted devices
        docs:
          desc: Lists all mounted filesystems to identify unusual mounts or external storage devices.
        mql: mount.list
      - uid: mondoo-macos-incident-response-uptime
        title: Operating system uptime
        docs:
          desc: Returns the system uptime to help determine when the system was last rebooted and establish incident timeline.
        mql: os.uptime
      - uid: mondoo-macos-incident-response-installed-packages
        title: Installed packages
        docs:
          desc: Lists all installed packages to identify potentially vulnerable or malicious software.
        mql: packages
      - uid: mondoo-macos-incident-response-running-services
        title: Running services
        docs:
          desc: Lists all currently running services with their status to identify suspicious or unauthorized services.
        mql: services.where(running == true) { name running enabled masked type }
      - uid: mondoo-macos-incident-response-alf-extensions
        title: Exceptions from the Application Layer Firewall
        docs:
          desc: Lists applications with firewall exceptions to identify software allowed to bypass the macOS Application Layer Firewall.
        mql: macos.alf.exceptions
      - uid: mondoo-macos-incident-response-check-recommended-updates
        title: Recommended OS and application updates
        docs:
          desc: Lists pending software updates to identify missing security patches and system updates.
        mql: parse.plist('/Library/Preferences/com.apple.SoftwareUpdate.plist').params['RecommendedUpdates']
