# Copyright (c) Mondoo, Inc.
# SPDX-License-Identifier: BUSL-1.1

packs:
  - uid: mondoo-m365-inventory
    name: Microsoft 365 Inventory Pack
    version: 1.0.0
    license: BUSL-1.1
    authors:
      - name: Mondoo, Inc
        email: hello@mondoo.com
    tags:
      mondoo.com/platform: ms365,saas
      mondoo.com/category: best-practices
    docs:
      desc: |
        The Microsoft 365 Asset Inventory Pack by Mondoo retrieves data about Microsoft 365 resources for asset inventory.

        To run this pack for an Microsoft 365 Tenant:

        ```bash
        cnspec scan ms365 --certificate-path certificate.combo.pem --tenant-id YOUR-TENANT-ID --client-id YOUR-CLIENT-ID --policy-bundle mondoo-m365-inventory.mql.yaml
        ```

        ## Join the community!
        Our goal is to build query packs that are simple to deploy and provide accurate and useful data.

        If you have any suggestions for improving this query pack, or if you need support, [join the Mondoo community](https://github.com/orgs/mondoohq/discussions) in GitHub Discussions.
    groups:
      - title: Organization
        filters:
          - asset.platform == "microsoft365" || asset.runtime == "ms-graph"
        queries:
          - uid: mondoo-asset-inventory-m365-organization-id
            title: Organization ID
            docs:
              desc: Returns the unique identifier of the Microsoft 365 organization.
            mql: |
              microsoft.organizations.first.id
          - uid: mondoo-asset-inventory-m365-organization-name
            title: Organization Name
            docs:
              desc: Returns the display name of the Microsoft 365 organization.
            mql: |
              microsoft.organizations.first.name
          - uid: mondoo-asset-inventory-m365-tenant-doamin-name
            title: Organization Tenant Domain Name
            docs:
              desc: Returns the primary domain name of the Microsoft 365 tenant.
            mql: |
              microsoft.tenantDomainName
          - uid: mondoo-asset-inventory-m365-organization-assigned-plans
            title: Organization Assigned Plans
            docs:
              desc: Lists all service plans assigned to the organization.
            mql: |
              microsoft.organizations.first.assignedPlans
          - uid: mondoo-asset-inventory-m365-organization-provisioned-plans
            title: Organization Provisioned Plans
            docs:
              desc: Lists all provisioned service plans for the organization.
            mql: |
              microsoft.organizations.first.provisionedPlans
          - uid: mondoo-asset-inventory-m365-organization-created
            title: Organization Created
            docs:
              desc: Returns the timestamp when the organization was created.
            mql: |
              microsoft.organizations.first.createdAt
          - uid: mondoo-asset-inventory-m365-organization-subscriptions
            title: Organization Subscriptions
            docs:
              desc: Lists all subscriptions associated with the tenant.
            mql: |
              microsoft.tenant.subscriptions

      - title: Groups
        filters:
          - asset.platform == "microsoft365" || asset.runtime == "ms-graph"
        queries:
          - uid: mondoo-asset-inventory-m365-groups
            title: Groups
            docs:
              desc: Lists all Microsoft 365 groups in the organization.
            mql: |
              microsoft.groups
          - uid: mondoo-asset-inventory-m365-groups-public
            title: Public Groups and their Members
            docs:
              desc: Lists all public groups with their members for visibility assessment.
            mql: |
              microsoft.groups.where (visibility == "Public") {id displayName securityEnabled members}
          - uid: mondoo-asset-inventory-m365-groups-security-enabled
            title: Groups no Security enabled
            docs:
              desc: Lists groups without security features enabled for security assessment.
            mql: |
              microsoft.groups.where (securityEnabled == false) {id displayName securityEnabled members}

      - title: Applications
        filters:
          - asset.platform == "microsoft365" || asset.runtime == "ms-graph"
        queries:
          - uid: mondoo-asset-inventory-m365-applications
            title: Applications
            docs:
              desc: Lists all applications registered in Microsoft Entra ID.
            mql: |
              microsoft.applications
          - uid: mondoo-asset-inventory-m365-applications-expired-credentials
            title: Applications with expired credentials
            docs:
              desc: Identifies applications with expired credentials that may need credential rotation.
            mql: |
              microsoft.applications.where(hasExpiredCredentials == true) {appId name owners createdAt servicePrincipal}
          - uid: mondoo-asset-inventory-m365-enterprise-applications
            title: Enterprise Applications
            docs:
              desc: Lists all enterprise applications (service principals) in the tenant.
            mql: |
              microsoft.enterpriseApplications

      - title: Device Management
        filters:
          - asset.platform == "microsoft365" || asset.runtime == "ms-graph"
        queries:
          - uid: mondoo-asset-inventory-m365-device-management-device-compliance-policy
            title: Device Compliance Policy
            docs:
              desc: Lists all Intune device compliance policies configured in the tenant.
            mql: |
              microsoft.devicemanagement.deviceCompliancePolicies
          - uid: mondoo-asset-inventory-m365-device-management-device-configurations
            title: Device Configurations
            docs:
              desc: Lists all Intune device configuration profiles in the tenant.
            mql: |
              microsoft.devicemanagement.deviceConfigurations

      - title: Domains
        filters:
          - asset.platform == "microsoft365" || asset.runtime == "ms-graph"
        queries:
          - uid: mondoo-asset-inventory-m365-domains
            title: Domains
            docs:
              desc: Lists all domains configured in the Microsoft 365 tenant.
            mql: |
              microsoft.domains

      - title: Users
        filters:
          - asset.platform == "microsoft365" || asset.runtime == "ms-graph"
        queries:
          - uid: mondoo-asset-inventory-m365-users
            title: Users
            docs:
              desc: Lists all users in the Microsoft 365 tenant.
            mql: |
              microsoft.users
          - uid: mondoo-asset-inventory-m365-users-account-enabled
            title: Users account enabled
            docs:
              desc: Lists all users with enabled accounts for active user inventory.
            mql: |
              microsoft.users.where(accountEnabled == true) {id givenName surname userPrincipalName}
          - uid: mondoo-asset-inventory-m365-users-mfa
            title: Users with no MFA enabled
            docs:
              desc: Identifies users without MFA enabled for security assessment.
            mql: |
              microsoft.users.where(mfaEnabled == false) {id givenName surname userPrincipalName}

      - title: Policies
        filters:
          - asset.platform == "microsoft365" || asset.runtime == "ms-graph"
        queries:
          - uid: mondoo-asset-inventory-m365-policies-admin-consent-request-policy
            title: Admin Consent Request Policy
            docs:
              desc: Returns the admin consent request policy configuration for app permissions.
            mql: |
              microsoft.policies.adminConsentRequestPolicy
          - uid: mondoo-asset-inventory-m365-policies-authorization-policy
            title: Authorization Policy
            docs:
              desc: Returns the authorization policy configuration for the tenant.
            mql: |
              microsoft.policies.authorizationPolicy
          - uid: mondoo-asset-inventory-m365-policies-consent-policy-settings
            title: Consent Policy Settings
            docs:
              desc: Returns the consent policy settings for application permissions.
            mql: |
              microsoft.policies.consentPolicySettings
          - uid: mondoo-asset-inventory-m365-policies-identity-security-defaults-enforcement-policy
            title: Identity Security Defaults Enforcement Policy
            docs:
              desc: Returns whether security defaults are enabled for the tenant.
            mql: |
              microsoft.policies.identitySecurityDefaultsEnforcementPolicy
          - uid: mondoo-asset-inventory-m365-policies-permission-grant-policies
            title: Permission Grant Policies
            docs:
              desc: Lists permission grant policies that control app consent.
            mql: |
              microsoft.policies.permissionGrantPolicies

      - title: Roles
        filters:
          - asset.platform == "microsoft365" || asset.runtime == "ms-graph"
        queries:
          - uid: mondoo-asset-inventory-m365-roles
            title: Roles
            docs:
              desc: Lists all directory roles available in Microsoft Entra ID.
            mql: |
              microsoft.roles

      - title: Security
        filters:
          - asset.platform == "microsoft365" || asset.runtime == "ms-graph"
        queries:
          - uid: mondoo-asset-inventory-m365-security-latest-secure-scores
            title: Latest Security Score
            docs:
              desc: Returns the latest Microsoft Secure Score with comparative metrics.
            mql: |
              microsoft.security.latestSecureScores {maxScore currentScore azureTenantId vendorInformation averageComparativeScores activeUserCount}
          - uid: mondoo-asset-inventory-m365-security-risky-users
            title: Risky Users
            docs:
              desc: Lists users flagged as risky by Microsoft Entra ID Identity Protection.
            mql: |
              microsoft.security.riskyUsers

      - title: Service Principals
        filters:
          - asset.platform == "microsoft365" || asset.runtime == "ms-graph"
        queries:
          - uid: mondoo-asset-inventory-m365-service-principals
            title: Service Principals
            docs:
              desc: Lists all service principals (app identities) in the tenant.
            mql: |
              microsoft.serviceprincipals
          - uid: mondoo-asset-inventory-m365-service-principals-enabled
            title: Enabled Service Principals
            docs:
              desc: Lists enabled service principals with their permissions and assignments.
            mql: |
              microsoft.serviceprincipals.where(enabled == true) {id name servicePrincipalNames assignments signInAudience permissions}

      - title: Settings
        filters:
          - asset.platform == "microsoft365" || asset.runtime == "ms-graph"
        queries:
          - uid: mondoo-asset-inventory-m365-settings
            title: Settings
            docs:
              desc: Returns the directory settings configured for the tenant.
            mql: |
              microsoft.settings
