# Copyright (c) Mondoo, Inc.
# SPDX-License-Identifier: BUSL-1.1

packs:
  - uid: mondoo-kubernetes-incident-response
    name: Kubernetes Incident Response Pack
    version: 1.1.0
    license: BUSL-1.1
    authors:
      - name: Mondoo, Inc
        email: hello@mondoo.com
    tags:
      mondoo.com/platform: kubernetes
      mondoo.com/category: security
    docs:
      desc: |
        ### Overview

        The Kubernetes Incident Response Pack retrieves security-related configuration data from Kubernetes clusters for investigation during a security incident. This includes cluster version, role bindings with cluster-admin permissions, pod security contexts, and container image information across various workload types.

        ### Run query pack

        To run this query pack against a Kubernetes cluster:

        ```bash
        cnquery scan k8s -f mondoo-kubernetes-incident-response.mql.yaml
        ```

        To run against a specific namespace:

        ```bash
        cnquery scan k8s --namespace <namespace> -f mondoo-kubernetes-incident-response.mql.yaml
        ```
    groups:
      - title: Cluster Incident Response
        filters:
          - asset.platform == "kubernetes" || asset.platform == "k8s-cluster"
        queries:
          - uid: mondoo-kubernetes-incident-response-cluster-version
            title: Kubernetes Cluster Version
            docs:
              desc: Returns the Kubernetes cluster version to identify potential vulnerabilities in the control plane.
            mql: |
              k8s.serverVersion
          - uid: mondoo-kubernetes-incident-response-role-bindings-with-cluster-admin-permissions
            title: Role bindings with cluster-admin permissions
            docs:
              desc: Lists namespace-scoped RoleBindings that grant cluster-admin privileges to identify accounts with excessive permissions.
            mql: |
              k8s.rolebindings.where(roleRef["kind"] == "ClusterRole" && roleRef["name"] == "cluster-admin") {
                name
                namespace
                subjects
                roleRef
              }
          - uid: mondoo-kubernetes-incident-response-clusterrole-bindings-with-cluster-admin-permissions
            title: ClusterRoleBindings with cluster-admin permissions
            docs:
              desc: Lists cluster-wide ClusterRoleBindings that grant cluster-admin privileges to identify accounts with full cluster access.
            mql: |
              k8s.clusterrolebindings.where(roleRef["kind"] == "ClusterRole" && roleRef["name"] == "cluster-admin") {
                name
                subjects
                roleRef
              }
      - title: Pods Incident Response
        filters:
          - asset.platform == "k8s-pod"
        queries:
          - uid: mondoo-kubernetes-incident-response-pod-security-context
            title: Pod Security Context
            docs:
              desc: Retrieves security context settings for all containers in the pod to identify privileged containers or insecure configurations.
            mql: |
              k8s.pod {
                ephemeralContainers {
                  securityContext
                }
                initContainers {
                  securityContext
                }
                containers {
                  securityContext
                }
              }
          - uid: mondoo-kubernetes-incident-response-pod-container
            title: Container image information
            docs:
              desc: Retrieves container image details including registry and image identifiers to trace the source of container images.
            mql: |
              k8s.pod {
                name
                namespace
                initContainers {
                  imageName
                  containerImage {
                    name
                    identifier
                    identifierType
                    repository {
                      name
                      registry
                    }
                  }
                }
                containers {
                  imageName
                  containerImage {
                    name
                    identifier
                    identifierType
                    repository {
                      name
                      registry
                    }
                  }
                }
                ephemeralContainers {
                  imageName
                  containerImage {
                    name
                    identifier
                    identifierType
                    repository {
                      name
                      registry
                    }
                  }
                }
                podSpec["nodeName"]
              }
      - title: Deployments Incident Response
        filters:
          - asset.platform == "k8s-deployment"
        queries:
          - uid: mondoo-kubernetes-incident-response-deployment-security-context
            title: Deployment Security Context
            docs:
              desc: Retrieves security context settings for all containers in the deployment to identify privileged containers or insecure configurations.
            mql: |
              k8s.deployment {
                initContainers {
                  securityContext
                }
                containers {
                  securityContext
                }
              }
          - uid: mondoo-kubernetes-incident-response-deployment-container
            title: Container image information
            docs:
              desc: Retrieves container image details including registry and image identifiers to trace the source of container images.
            mql: |
              k8s.deployment {
                name
                namespace
                initContainers {
                  imageName
                  containerImage {
                    name
                    identifier
                    identifierType
                    repository {
                      name
                      registry
                    }
                  }
                }
                containers {
                  imageName
                  containerImage {
                    name
                    identifier
                    identifierType
                    repository {
                      name
                      registry
                    }
                  }
                }
              }
      - title: CronJobs Incident Response
        filters:
          - asset.platform == "k8s-cronjob"
        queries:
          - uid: mondoo-kubernetes-incident-response-cronjob-security-context
            title: CronJob Security Context
            docs:
              desc: Retrieves security context settings for all containers in the cronjob to identify privileged containers or insecure configurations.
            mql: |
              k8s.cronjob {
                initContainers {
                  securityContext
                }
                containers {
                  securityContext
                }
              }
          - uid: mondoo-kubernetes-incident-response-cronjob-container
            title: Container image information
            docs:
              desc: Retrieves container image details including registry and image identifiers to trace the source of container images.
            mql: |
              k8s.cronjob {
                name
                namespace
                initContainers {
                  imageName
                  containerImage {
                    name
                    identifier
                    identifierType
                    repository {
                      name
                      registry
                    }
                  }
                }
                containers {
                  imageName
                  containerImage {
                    name
                    identifier
                    identifierType
                    repository {
                      name
                      registry
                    }
                  }
                }
              }
      - title: Jobs Incident Response
        filters:
          - asset.platform == "k8s-job"
        queries:
          - uid: mondoo-kubernetes-incident-response-job-security-context
            title: Job Security Context
            docs:
              desc: Retrieves security context settings for all containers in the job to identify privileged containers or insecure configurations.
            mql: |
              k8s.job {
                initContainers {
                  securityContext
                }
                containers {
                  securityContext
                }
              }
          - uid: mondoo-kubernetes-incident-response-job-container
            title: Container image information
            docs:
              desc: Retrieves container image details including registry and image identifiers to trace the source of container images.
            mql: |
              k8s.job {
                name
                namespace
                initContainers {
                  imageName
                  containerImage {
                    name
                    identifier
                    identifierType
                    repository {
                      name
                      registry
                    }
                  }
                }
                containers {
                  imageName
                  containerImage {
                    name
                    identifier
                    identifierType
                    repository {
                      name
                      registry
                    }
                  }
                }
              }
      - title: DaemonSets Incident Response
        filters:
          - asset.platform == "k8s-daemonset"
        queries:
          - uid: mondoo-kubernetes-incident-response-daemonset-security-context
            title: DaemonSet Security Context
            docs:
              desc: Retrieves security context settings for all containers in the daemonset to identify privileged containers or insecure configurations.
            mql: |
              k8s.daemonset {
                initContainers {
                  securityContext
                }
                containers {
                  securityContext
                }
              }
          - uid: mondoo-kubernetes-incident-response-daemonset-container
            title: Container image information
            docs:
              desc: Retrieves container image details including registry and image identifiers to trace the source of container images.
            mql: |
              k8s.daemonset {
                name
                namespace
                initContainers {
                  imageName
                  containerImage {
                    name
                    identifier
                    identifierType
                    repository {
                      name
                      registry
                    }
                  }
                }
                containers {
                  imageName
                  containerImage {
                    name
                    identifier
                    identifierType
                    repository {
                      name
                      registry
                    }
                  }
                }
              }
      - title: StatefulSets Incident Response
        filters:
          - asset.platform == "k8s-statefulset"
        queries:
          - uid: mondoo-kubernetes-incident-response-statefulset-security-context
            title: StatefulSet Security Context
            docs:
              desc: Retrieves security context settings for all containers in the statefulset to identify privileged containers or insecure configurations.
            mql: |
              k8s.statefulset {
                initContainers {
                  securityContext
                }
                containers {
                  securityContext
                }
              }
          - uid: mondoo-kubernetes-incident-response-statefulset-container
            title: Container image information
            docs:
              desc: Retrieves container image details including registry and image identifiers to trace the source of container images.
            mql: |
              k8s.statefulset {
                name
                namespace
                initContainers {
                  imageName
                  containerImage {
                    name
                    identifier
                    identifierType
                    repository {
                      name
                      registry
                    }
                  }
                }
                containers {
                  imageName
                  containerImage {
                    name
                    identifier
                    identifierType
                    repository {
                      name
                      registry
                    }
                  }
                }
              }
      - title: ReplicaSets Incident Response
        filters:
          - asset.platform == "k8s-replicaset"
        queries:
          - uid: mondoo-kubernetes-incident-response-replicaset-security-context
            title: ReplicaSet Security Context
            docs:
              desc: Retrieves security context settings for all containers in the replicaset to identify privileged containers or insecure configurations.
            mql: |
              k8s.replicaset {
                initContainers {
                  securityContext
                }
                containers {
                  securityContext
                }
              }
          - uid: mondoo-kubernetes-incident-response-replicaset-container
            title: Container image information
            docs:
              desc: Retrieves container image details including registry and image identifiers to trace the source of container images.
            mql: |
              k8s.replicaset {
                name
                namespace
                initContainers {
                  imageName
                  containerImage {
                    name
                    identifier
                    identifierType
                    repository {
                      name
                      registry
                    }
                  }
                }
                containers {
                  imageName
                  containerImage {
                    name
                    identifier
                    identifierType
                    repository {
                      name
                      registry
                    }
                  }
                }
              }
