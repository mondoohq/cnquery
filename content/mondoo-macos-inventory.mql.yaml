# Copyright (c) Mondoo, Inc.
# SPDX-License-Identifier: BUSL-1.1

packs:
  - uid: mondoo-macos-inventory
    name: macOS Inventory Pack
    version: 1.6.0
    license: BUSL-1.1
    authors:
      - name: Mondoo, Inc
        email: hello@mondoo.com
    tags:
      mondoo.com/platform: macos
      mondoo.com/category: best-practices
    docs:
      desc: |
        The macOS Inventory Pack retrieves data about macOS hosts for asset inventory.

        ## Local scan
        To run this pack locally on a macOS host:

        ```bash
        cnquery scan local -f mondoo-macos-inventory.mql.yaml
        ```

        ## Remote scan
        To run this pack against a remote macOS host using SSH (requires Remote Management is activated in System Preferences):

        ```bash
        cnquery scan ssh <user>@<ip_address> -i <identity_file> -f mondoo-macos-inventory.mql.yaml
        ```

        ## Join the community!
        Our goal is to build query packs that are simple to deploy and provide accurate and useful data.

        If you have any suggestions for improving this query pack, or if you need support, [join the Mondoo community](https://github.com/orgs/mondoohq/discussions) in GitHub Discussions.
    filters:
      - asset.platform == "macos"
    queries:
      - uid: mondoo-macos-machine-model-identifier
        title: Machine model identifier
        docs:
          desc: Returns the Mac hardware model identifier (e.g., MacBookPro18,1).
        mql: |
          macos.hardware.machineModel
      - uid: mondoo-macos-machine-model-name
        title: Machine model name
        docs:
          desc: Returns the human-readable Mac model name (e.g., MacBook Pro).
        mql: |
          macos.hardware.machineName
      - uid: mondoo-macos-model-part-number
        title: Model part number
        docs:
          desc: Returns the Apple model/part number for the hardware.
        mql: |
          macos.hardware.modelNumber
      - uid: mondoo-macos-serial-number
        title: System serial number
        docs:
          desc: Returns the unique hardware serial number for asset tracking.
        mql: |
          macos.hardware.serialNumber
      - uid: mondoo-macos-cpu-type
        title: CPU type
        docs:
          desc: Returns the processor chip type (e.g., Apple M1, Intel Core i7).
        mql: |
          macos.hardware.chipType
      - uid: mondoo-macos-physical-memory
        title: Physical memory size
        docs:
          desc: Returns the total installed RAM.
        mql: |
          macos.hardware.physicalMemory
      - uid: mondoo-asset-info
        title: Asset information
        docs:
          desc: Returns basic asset information including platform, architecture, and version.
        mql: asset { kind title platform name arch runtime version }
      - uid: mondoo-hostname
        title: Hostname
        docs:
          desc: Returns the system hostname.
        mql: os.hostname
      - uid: mondoo-macos-uptime
        title: Operating system uptime
        docs:
          desc: Returns how long the system has been running since last boot.
        filters: mondoo.capabilities.contains("run-command")
        mql: os.uptime
      - uid: mondoo-macos-processes
        title: Running processes
        docs:
          desc: Lists all running processes with their PID, command, and flags.
        filters: mondoo.capabilities.contains("run-command")
        mql: processes { pid command flags }
      - uid: mondoo-macos-kernel-modules
        title: Kernel modules
        docs:
          desc: Lists loaded kernel extensions (kexts) with their load status.
        filters: mondoo.capabilities.contains("run-command")
        mql: kernel.modules { name loaded }
      - uid: mondoo-macos-mounts
        title: Mounted devices
        docs:
          desc: Lists all mounted filesystems with their paths, types, and mount options.
        mql: mount.list { path fstype device options }
      - uid: mondoo-macos-users
        title: Regular users
        docs:
          desc: Lists regular user accounts (excluding system accounts starting with underscore).
        mql: users.where( name != /^_/ && shell != "/usr/bin/false" && name != "root")
      - uid: mondoo-macos-packages
        title: Installed packages
        docs:
          desc: Lists all installed packages with version, architecture, and origin information.
        mql: packages { name version arch installed epoch origin purl }
      - uid: mondoo-macos-running-services
        title: Running services
        docs:
          desc: Lists all currently running services (launchd jobs) with their status.
        filters: mondoo.capabilities.contains("run-command")
        mql: services.where(running == true) { name running enabled masked type }
      - uid: mondoo-macos-ports-listening
        title: Listening ports
        docs:
          desc: Lists all listening network ports with their associated processes.
        filters: mondoo.capabilities.contains("run-command")
        mql: ports.where(state != "close") { user state port address protocol process remoteAddress remotePort }
      - uid: mondoo-macos-active-connections
        title: Active network connections
        docs:
          desc: Lists all active network connections with their associated processes.
        filters: mondoo.capabilities.contains("run-command")
        mql: ports.where(state != "close") { user state port address protocol process remoteAddress remotePort }
      - uid: mondoo-macos-interface-configuration
        title: Network interface configuration
        docs:
          desc: Returns detailed network interface configuration for all interfaces.
        mql: network.interfaces{*}
      - uid: mondoo-macos-sshd-interface-configuration
        title: sshd configuration
        docs:
          desc: Returns the SSH server configuration parameters.
        mql: sshd.config.params
      - uid: mondoo-macos-recommended-software-updates
        title: Recommended software updates
        docs:
          desc: Lists pending macOS and application updates recommended by Apple.
        mql: parse.plist('/Library/Preferences/com.apple.SoftwareUpdate.plist').params['RecommendedUpdates']
      - uid: mondoo-macos-hardware-information
        title: Hardware information
        docs:
          desc: Returns comprehensive hardware information including model, chip type, and memory.
        mql: macos.hardware{ machineModel machineName modelNumber chipType serialNumber platformUUID physicalMemory numberProcessors }
      - uid: mondoo-macos-storage
        title: Storage Data
        docs:
          desc: Returns detailed storage information from system profiler.
        mql: |
          parse.json(content: command('system_profiler SPStorageDataType -json').stdout).params
      - uid: mondoo-macos-power
        title: Power Data
        docs:
          desc: Returns power and battery information from system profiler.
        mql: |
          parse.json(content: command('system_profiler SPPowerDataType -json').stdout).params
      - uid: mondoo-macos-network
        title: Network Data
        docs:
          desc: Returns network configuration from system profiler.
        mql: |
          parse.json(content: command('system_profiler SPNetworkDataType -json').stdout).params
      - uid: mondoo-macos-profile
        title: Configuration Profile Data
        docs:
          desc: Returns installed MDM configuration profiles from system profiler.
        mql: |
          parse.json(content: command('system_profiler SPConfigurationProfileDataType -json').stdout).params
      - uid: mondoo-macos-logged-in-users
        title: Logged-in users
        docs:
          desc: Lists currently logged-in users.
        mql: command('w -h').stdout
      - uid: mondoo-macos-system-extensions
        title: macOS System Extensions
        docs:
          desc: Lists installed system extensions with their activation status.
        mql: macos.systemExtensions { active enabled identifier state version }
