name: Update mql and provider dependencies

on:
  schedule:
    - cron: "11 8 * * 1" # every monday
  workflow_dispatch:

permissions:
  contents: read

jobs:
  update-deps:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      # https://github.com/peter-evans/create-pull-request/issues/48
      # https://github.com/peter-evans/create-pull-request/blob/main/docs/concepts-guidelines.md#push-using-ssh-deploy-keys
      # tl;dr:
      # The GITHUB_TOKEN is limited when creating PRs from a workflow
      # because of that we use a ssh key for which the limitations do not apply
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          ssh-key: ${{ secrets.CNQUERY_DEPLOY_KEY_PRIV }}

      - name: Import environment variables from file
        run: cat ".github/env" >> $GITHUB_ENV

      - name: Install Go
        uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6.2.0
        with:
          go-version: ">=${{ env.golang-version }}"
          cache: false

      - name: Update deps
        id: update-deps
        run: |
          shopt -s expand_aliases
          alias version="go run providers-sdk/v1/util/version/version.go"
          version mod-update . --latest
          version mod-update providers/*/ --latest
          version mod-tidy providers/*/
          # This is first updated and later downgraded by another dependency
          # Unless this is fixed, bump it back up
          go get github.com/google/go-containerregistry@v0.20.7
          version mod-tidy .

      - name: Prepare title and branch name
        id: branch
        run: |
          BRANCH_NAME="version/deps_update_$(date +%Y%m%d_%H%M)"
          COMMIT_MSG="ðŸ§¹ Update deps for mql and providers $(date +%Y%m%d)"
          echo "COMMIT_TITLE=${COMMIT_MSG}" >> $GITHUB_OUTPUT
          echo "BRANCH_NAME=${BRANCH_NAME}" >> $GITHUB_OUTPUT

      # We have to use this extensions, because `gh pr create` does not support the ssh key case
      - name: Create pull request
        id: cpr
        uses: peter-evans/create-pull-request@98357b18bf14b5342f975ff684046ec3b2a07725 # v8.0.0
        with:
          base: main
          labels: dependencies,go
          committer: "Mondoo Tools <tools@mondoo.com>"
          commit-message: ${{ steps.branch.outputs.COMMIT_TITLE }}
          author: "Mondoo Tools <tools@mondoo.com>"
          title: ${{ steps.branch.outputs.COMMIT_TITLE }}
          branch: ${{ steps.branch.outputs.BRANCH_NAME }}
          body-path: .github/pr-body.md

      - name: PR infos
        if: ${{ steps.cpr.outputs.pull-request-number }}
        run: |
          echo "Pull Request Number - ${{ steps.cpr.outputs.pull-request-number }}"
          echo "Pull Request URL - ${{ steps.cpr.outputs.pull-request-url }}"
