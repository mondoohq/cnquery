#!/bin/bash
set -e

# Sign RPMs using the existing GPG setup
if ls dist/*.rpm 1> /dev/null 2>&1; then
  echo "Signing RPM packages with Docker..."
  
  # Get the signing key ID from the GPG key
  KEY_ID=$(gpg --import --import-options show-only --with-colons "$GPG_KEY_PATH" 2>/dev/null | grep '^pub:' | cut -d: -f5 | tail -8c)
  
  docker run --rm \
    -v $(pwd):/workspace \
    -v "$GPG_KEY_PATH":/tmp/signing-key \
    -e RPM_PASSPHRASE="$NFPM_DEFAULT_RPM_PASSPHRASE" \
    -e KEY_ID="$KEY_ID" \
    registry.fedoraproject.org/fedora:latest \
    sh -c "
      dnf install -y rpm-sign pinentry
      
      # Configure GPG for non-interactive use
      mkdir -p ~/.gnupg
      chmod 700 ~/.gnupg
      echo 'use-agent' >> ~/.gnupg/gpg.conf
      echo 'pinentry-mode loopback' >> ~/.gnupg/gpg.conf
      echo 'allow-loopback-pinentry' >> ~/.gnupg/gpg-agent.conf
      
      # Import the key
      gpg --batch --yes --pinentry-mode loopback --passphrase \"\$RPM_PASSPHRASE\" --import /tmp/signing-key
      
      # Configure RPM macros
      echo \"%_signature gpg\" >> ~/.rpmmacros
      echo \"%_gpg_name \$KEY_ID\" >> ~/.rpmmacros
      echo \"%_gpg_sign_cmd_extra_args --batch --no-tty --pinentry-mode loopback --passphrase \\\"\$RPM_PASSPHRASE\\\"\" >> ~/.rpmmacros
      
      # Sign the RPMs
      find /workspace/dist -name '*.rpm' -exec rpmsign --addsign {} \;
    "
fi

echo "RPM signing completed. Checksums will be regenerated by goreleaser."