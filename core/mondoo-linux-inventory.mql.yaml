# Copyright (c) Mondoo, Inc.
# SPDX-License-Identifier: BUSL-1.1

packs:
  - uid: mondoo-linux-inventory
    name: Linux Inventory Pack
    version: 1.4.0
    license: BUSL-1.1
    authors:
      - name: Mondoo, Inc
        email: hello@mondoo.com
    tags:
      mondoo.com/platform: linux
      mondoo.com/category: best-practices
    docs:
      desc: |
        The Linux Inventory Pack by Mondoo retrieves data about Linux hosts for asset inventory. 

        ## Local scan
        To run this pack locally on a Linux host:

        ```bash
        cnquery scan local -f mondoo-linux-inventory.mql.yaml
        ```

        ## Remote scan
        To run this pack against a remote Linux host using SSH:

        ```bash
        cnquery scan ssh <user>@<ip_address> -i <identity_file> -f mondoo-linux-inventory.mql.yaml
        ```

        ## Join the community!
        Our goal is to build query packs that are simple to deploy and provide accurate and useful data. 

        If you have any suggestions for improving this query pack, or if you need support, [join the Mondoo community](https://github.com/orgs/mondoohq/discussions) in GitHub Discussions.
    filters:
      - asset.family.contains("linux")
    queries:
      - uid: mondoo-linux-asset-info
        title: Asset information
        mql: asset { kind title platform name arch runtime }
      - uid: mondoo-linux-hostname
        title: Hostname
        mql: os.hostname
      - uid: mondoo-linux-platform
        title: Platform
        mql: asset.platform
      - uid: mondoo-linux-users
        title: Regular users with shell access
        mql: users.where( shell != "/sbin/nologin" && uid >= 1000 && name != "root")
      - uid: mondoo-linux-groups-wheel
        title: Members of the wheel group
        mql: groups.where( name == "wheel") { members }
      - uid: mondoo-linux-installed-kernel
        title: Installed kernels
        filters: mondoo.capabilities.contains("run-command")
        mql: kernel.installed
      - uid: mondoo-linux-kernel-info
        title: Running kernel versions
        filters: mondoo.capabilities.contains("run-command")
        mql: kernel.info
      - uid: mondoo-linux-kernel-modules
        title: Kernel modules
        mql: kernel.modules { name loaded }
      - uid: mondoo-linux-processes
        title: Running processes
        filters: mondoo.capabilities.contains("run-command")
        mql: processes { pid  command }
      - uid: mondoo-linux-mounts
        title: Mounted devices
        mql: mount.list
      - uid: mondoo-linux-listening-ports
        title: Listening ports
        filters: mondoo.capabilities.contains("run-command")
        mql: ports.listening
      - uid: mondoo-linux-uptime
        title: Operating system uptime
        filters: mondoo.capabilities.contains("run-command")
        mql: os.uptime
      - uid: mondoo-linux-installed-packages
        title: Installed packages
        mql: packages
      - uid: mondoo-linux-running-services
        title: Running services
        mql: services.where( running == true )
      - uid: mondoo-linux-interface-configuration
        title: Network interface configuration
        filters: mondoo.capabilities.contains("run-command")
        mql: |
          parse.json(content: command('ip -j a').stdout).params
      - uid: mondoo-sshd-interface-configuration
        title: sshd configuration
        filters: package('openssh-server').installed || package('openssh').installed
        mql: sshd.config.params
      - uid: mondoo-linux-system-manufacturer
        title: System manufacturer
        mql: machine.baseboard.manufacturer
      - uid: mondoo-linux-system-product-name
        title: System product name
        mql: machine.baseboard.product
      - uid: mondoo-linux-cpu-type
        title: CPU type
        mql: |
          command('cat /proc/cpuinfo | grep "model name" | sort -u | cut -d : -f 2-').stdout.trim
      - uid: mondoo-linux-root-volume
        title: Root volume size and filesystem type
        mql: |
          command("df -TH / | grep '/dev' | awk '{ print $3 "+'" "'+" $2 }'").stdout.trim
      - uid: mondoo-linux-physical-memory
        title: Physical memory size
        mql: |
          command("free --mega | grep Mem | awk '{ print $2}'").stdout.trim + "M"
